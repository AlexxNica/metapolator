$def with (master, glyphid, A_glyphjson, B_glyphjson, M_glyphjson, localparametersA, localparametersB, origins)
<title>
Project $master.fontname
</title>
<link rel="stylesheet" type="text/css" href="/static/mfg.css"/>
<script src="http://cdnjs.cloudflare.com/ajax/libs/paper.js/0.9.9/paper.js"></script>

<div class="row">
  <div class="col-md-4">
    <h4>Font A</h4>
    <canvas id="canvas-a" width="400" height="400"></canvas>

    <div class="well">
      <h4>Parameters Font A <small><a href="/view/$master.fontname/$glyphid/settings/">change</a></small></h4>

      $if not localparametersA:
        <div class="label label-danger">This font has not specified local parameters</div>
      $else:
        <div style="font-family: monospace;">
          px: $localparametersA.px<br />
          width: $localparametersA.width<br />
          space: $localparametersA.space<br />
          xheight: $localparametersA.xheight<br />
          capital: $localparametersA.capital<br />
          boxheight: $localparametersA.boxheight<br />
          ascender: $localparametersA.ascender<br />
          descender: $localparametersA.descender<br />
          inktrap: $localparametersA.inktrap<br />
          stemcut: $localparametersA.stemcut<br />
          skeleton: $localparametersA.skeleton<br />
          superness: $localparametersA.superness<br />
          over: $localparametersA.over
        </div>
    </div>
  </div>

  <div class="col-md-4" style="border: solid 2px black;">
    <h4>Metapolation</h4>
    <canvas width="400" height="400" id="canvas-m"></canvas>

    <div class="well">
      <h4>Global Parameters <small><a href="/view/$master.fontname/$glyphid/settings/">change</a></small></h4>
    </div>
  </div>

  <div class="col-md-4">
    <h4>Font B</h4>
    <canvas id="canvas-b" height="400" width="400"></canvas>

    <div class="well">
      <h4>Parameters Font B <small><a href="/view/$master.fontname/$glyphid/settings/">change</a></small></h4>
      $if not localparametersB:
        <div class="label label-danger">This font has not specified local parameters</div>
      $else:
        <div style="font-family: monospace;">
          px: $localparametersB.px<br />
          width: $localparametersB.width<br />
          space: $localparametersB.space<br />
          xheight: $localparametersB.xheight<br />
          capital: $localparametersB.capital<br />
          boxheight: $localparametersB.boxheight<br />
          ascender: $localparametersB.ascender<br />
          descender: $localparametersB.descender<br />
          inktrap: $localparametersB.inktrap<br />
          stemcut: $localparametersB.stemcut<br />
          skeleton: $localparametersB.skeleton<br />
          superness: $localparametersB.superness<br />
          over: $localparametersB.over
        </div>
    </div>
  </div>
</div>


<script type="text/paperscript" canvas="canvas-m">
  var EDGE_JSON = $:M_glyphjson;

  function getPoint(x, y) {
    width = EDGE_JSON.width;
    height = EDGE_JSON.height;

    ratio = width / height;
    if (width > height) {
      w = scope.view.size.width - 100;
      h = w / ratio;
    } else {
      h = scope.view.size.height - 100;
      w = h * ratio;
    }
    nx = w * x / width;
    ny = h * y / height;

    return new Point(nx, ny)
  }

  var edges = EDGE_JSON.edges;
  var pathes = [];
  for (var i = 0; i < edges.length; i++) {
      for (var j = 0; j < edges[i].contours.length; j++) {
          var path = new Path();
          var contours = edges[i].contours[j];
          for (var k = 0; k < contours.length; k++) { // contours.length
              contour = contours[k];

              var point = getPoint(Number(contour.x), 500 - Number(contour.y));
              var handleIn = getPoint(Number(contour.controls[0].x) - Number(contour.x),
                                       Number(contour.y) - Number(contour.controls[0].y));
              var handleOut = getPoint(Number(contour.controls[1].x) - Number(contour.x),
                                        Number(contour.y) - Number(contour.controls[1].y));
              segment = new Segment(point, handleIn, handleOut);
              path.add(segment);
          }
          path.fillColor = {
              hue: 360 * Math.random(),
              saturation: 1,
              brightness: 1,
              alpha: 0.5
          };
          path.closed = true;
          path.strokeColor = new Color(0.5, 0, 0.5);
          path.position.y += +200;
          pathes.push(path);
      }
  }
</script>


<script type="text/paperscript" canvas="canvas-a">
  var EDGE_JSON = $:A_glyphjson;

  var JSON = $:origins['a'];

  function getPoint(x, y, i) {
    width = EDGE_JSON.width;
    height = EDGE_JSON.height;

    var r = resize(x, y, EDGE_JSON.width, EDGE_JSON.height,
                   scope.view.size.width - 100, scope.view.size.height - 100)
    return new Point(r.x, r.y);
  }

  function resize(x, y, width, height, newwidth, newheight) {
    ratio = width / height;
    if (width > height) {
      w = newwidth;
      h = w / ratio;
    } else {
      h = newheight;
      w = h * ratio;
    }
    nx = w * x / width;
    ny = h * y / height;
    return {x: nx, y: ny}
  }

  var edges = EDGE_JSON.edges;
  for (var i = 0; i < edges.length; i++) {
      for (var j = 0; j < edges[i].contours.length; j++) {
          var path = new Path();
          var contours = edges[i].contours[j];
          for (var k = 0; k < contours.length; k++) { // contours.length
              contour = contours[k];
              var point = getPoint(Number(contour.x), 500 - Number(contour.y), k);
              var handleIn = getPoint(Number(contour.controls[0].x) - Number(contour.x),
                                       Number(contour.y) - Number(contour.controls[0].y));
              var handleOut = getPoint(Number(contour.controls[1].x) - Number(contour.x),
                                        Number(contour.y) - Number(contour.controls[1].y));
              path.add(new Segment(point, handleIn, handleOut));
          }
          path.closed = true;
          path.position.y += +200;
          path.fillColor = {
              hue: 360 * Math.random(),
              saturation: 1,
              brightness: 1,
              alpha: 0.5
          };
      }
  }

  var pathes = [];
  for (var i = 0; i < JSON.points.length; i++) {
    if (!JSON.points[i].iszpoint) {
      continue;
    }
    var point = getPoint(Number(JSON.points[i].x), 500 - Number(JSON.points[i].y), 0);
    var path = new Path.Rectangle(point, 1);
    path.closed = true;
    path.selected = true;
//    path.fullySelected = true;
//    path.strokeColor = new Color(0.5, 0, 0.5);
    path.position.y += +200;
    pathes.push(path);
  }

  var currentSegment, mode, type, pointnumber, pathnumber;

  function restore_original_coords(point) {
    var r = resize(point.x, point.y, scope.view.size.width - 100, scope.view.size.height - 100,
               EDGE_JSON.width, EDGE_JSON.height);
    return r;
  }

  var box = new Path.Rectangle(new Point(50, 50), new Size(50, 50));
  box.style = {
      strokeColor: 'red',
      strokeWidth: '5'
  };

//  function onFrame(event) {
    // Each frame, rotate the copy by 1 degree:
 //   box.rotate(1);
 // }

  var currentsegment = null;
  var currentpointnr = null;

  function onMouseDown(event) {
    for (var k = 0; k < pathes.length; k++) {
      var point = pathes[k].getNearestPoint(event.point);
      if ((event.point - point).length < 5) {
        box.position = point;
        currentsegment = path;
        currentpointnr = k + 1;
        console.log(currentsegment.position);
        break;
      };
    }
  }

  function onMouseUp(event) {
    if (currentsegment) {
      console.log(currentpointnr);

      var x = event.point.x;
      var y = event.point.y - 200;
      var xycoord = restore_original_coords(new Point(x, y));

      jQuery.post('', {
        pointnr: currentpointnr,
        x: xycoord.x,
        y: 500 - xycoord.y,
        source: 'a'
      });
    }
    currentsegment = currentpointnr = null;
  }

  function onMouseMove(event) {
    if (!currentsegment) {
      return;
    }
    box.position = event.point;
    currentsegment.position = event.point;
  }
</script>


<script type="text/paperscript" canvas="canvas-b">
  var EDGE_JSON = $:B_glyphjson;

  var JSON = $:origins['b'];

  function getPoint(x, y, i) {
    width = EDGE_JSON.width;
    height = EDGE_JSON.height;

    var r = resize(x, y, EDGE_JSON.width, EDGE_JSON.height,
                   scope.view.size.width - 100, scope.view.size.height - 100)
    return new Point(r.x, r.y);
  }

  function resize(x, y, width, height, newwidth, newheight) {
    ratio = width / height;
    if (width > height) {
      w = newwidth;
      h = w / ratio;
    } else {
      h = newheight;
      w = h * ratio;
    }
    nx = w * x / width;
    ny = h * y / height;
    return {x: nx, y: ny}
  }

  var edges = EDGE_JSON.edges;
  for (var i = 0; i < edges.length; i++) {
      for (var j = 0; j < edges[i].contours.length; j++) {
          var path = new Path();
          var contours = edges[i].contours[j];
          for (var k = 0; k < contours.length; k++) { // contours.length
              contour = contours[k];
              var point = getPoint(Number(contour.x), 500 - Number(contour.y), k);
              var handleIn = getPoint(Number(contour.controls[0].x) - Number(contour.x),
                                       Number(contour.y) - Number(contour.controls[0].y));
              var handleOut = getPoint(Number(contour.controls[1].x) - Number(contour.x),
                                        Number(contour.y) - Number(contour.controls[1].y));
              path.add(new Segment(point, handleIn, handleOut));
          }
          path.closed = true;
          path.position.y += +200;
          path.fillColor = {
              hue: 360 * Math.random(),
              saturation: 1,
              brightness: 1,
              alpha: 0.5
          };
      }
  }

  var pathes = [];
  for (var i = 0; i < JSON.points.length; i++) {
    var point = getPoint(Number(JSON.points[i].x), 500 - Number(JSON.points[i].y), 0);
    var path = new Path.Rectangle(point, 1);
    path.closed = true;
    path.selected = true;
    path.fullySelected = true;
    path.strokeColor = new Color(0.5, 0, 0.5);
    path.position.y += +200;
    pathes.push(path);
  }

  var currentSegment, mode, type, pointnumber, pathnumber;

  function restore_original_coords(point) {
    var r = resize(point.x, point.y, scope.view.size.width - 100, scope.view.size.height - 100,
               EDGE_JSON.width, EDGE_JSON.height);
    return r;
  }

  var box = new Path.Rectangle(new Point(50, 50), new Size(50, 50));
  box.style = {
      strokeColor: 'red',
      strokeWidth: '5'
  };

  function onFrame(event) {
    // Each frame, rotate the copy by 1 degree:
    box.rotate(1);
  }

  var currentsegment = null;
  var currentpointnr = null;

  function onMouseDown(event) {
    for (var k = 0; k < pathes.length; k++) {
      var point = pathes[k].getNearestPoint(event.point);
      if ((event.point - point).length < 5) {
        box.position = point;
        currentsegment = path;
        currentpointnr = k + 1;
        console.log(currentsegment.position);
        break;
      };
    }
  }

  function onMouseUp(event) {
    if (currentsegment) {
      console.log(currentpointnr);

      var x = event.point.x;
      var y = event.point.y - 200;
      var xycoord = restore_original_coords(new Point(x, y));

      jQuery.post('', {
        pointnr: currentpointnr,
        x: xycoord.x,
        y: 500 - xycoord.y,
        source: 'b'
      });
    }
    currentsegment = currentpointnr = null;
  }

  function onMouseMove(event) {
    if (!currentsegment) {
      return;
    }
    box.position = event.point;
    currentsegment.position = event.point;
  }
</script>
